# Practice React in Rails

([demo code and Chinese version](https://github.com/baurine/react-in-rails-practice))

## Background

At first I want to talk about why I want to share this.

it is some experience from podknife project, and I think maybe it can be used for other projects in the future.

Podknife is a web project which collects many podcasts information where we can search podcasts and view podcast detail information.

At the beginning, Podknife is a traditional rails project, it renders the front pages by rails in the server side.

Then, client has some ideas:

1. they want to use React, because it is cool, I guess.
1. must consider the SEO (Search Engine Optimization) (what's SEO?)

React is a Client Side Rendering (CSR) (what's CSR?) javascript front-end library defaultly, but if we need to consider SEO, it means we need render the view in the server side as traditional rails project does, we often call this SSR.

Thanks God, after researching, we found a gem called react-rails can help us use react in rails, and even do SSR. but, unfortunately, this gem is not perfect, although now we can use react in rails, but we can't use those abundant npm packages, it means we need to implement all components by ourselves.

it is really annoying, and it is always a pain in my heart.

until last month, it is still ok, because most components are not very complex, untill one day, we need to implement a range slider component, it is too complex that we can't afford too much time to implement it. other guys already implemented it but we can't use it, terrible.

so we start to think how can we resolve this pain.

the good news is, last year when rails 5.1 released, it also released a gem, called webpacker, it wraps the webpack tool to rails. what's webpack, webpack is the most popular front-end package tool.

by wepbacker, we can easily use npm packages in rails.

so webpacker + react-rails, support us to use react and do SSR easily in rails.

## Content Table

1. What's CSR (client side rendering) & SSR (server side rendering), comparison
1. What's SEO (search engine optimization), How search engine works
1. CSR's drawbacks (SEO not friendly & blank first screen)
1. Demo webpacker to support use react in rails
   - Setup webpacker
   - Implment SSR / CSR example (MoviesController)
1. Demo use third party npm packages (react-stars)
1. Demo blank first screen and workaround (loading status)
1. Demo react-rails to support SSR for react
1. Summary

## CSR & SSR

A comparison, demo, see their page source

they look exactly same right, in fact it is true they are same when render in the browser.

but let's see their page source, it is totally different.

the ssr page, you can see the same content in page source as you see in browser,

but for csr page, it is empty, nothing in the body tag in page source, just a javascript file.

so, it is obvious, the csr page, its content is generated by javascript code, in cient side.

while the ssr page, its content is generated in server side.

make sense?

## SEO

- Search Engine Optimization
- How search engine works

let see how search engine works. when we search web pages by Google, why google can find thoes pages include the search keyword.

(demo search '头号玩家' by google)

because the each search engine has its spider, the spider crawls all web pages in the world very day, it parses and extract the content from each page then store to their database.

but notice, spider won't run any javascript code in the page.

let's compare how spider parse SSR and CSR pages.

(2 images)

so that's why we say SSR is friendly for SEO, while CSR is not.

general speaking, the content related sites need to consider SEO, likes, blog, news site.

some kinds sites don't care about SEO, likes, admin interface, sns that's can't access anonymously, forum...

## CSR's drawbacks

- SEO not friendly (just talked about)
- blank first screen

we will demo it later, but now we can have a glance in advance.

let's assume the server is very slow, it needs 5 seconds to get the data from database.

(demo)

so, what's you feeling about these 2 kinds of pages. you must feel different for them, right?

the CSR page has a long time, it displays a totally blank screen, but the SSR doesn't.

so this is the second drawback of CSR.

we'll see how it will be resolved later.

## Webpacker

so, let's start to demo how to use webpacker to support you to use React in Rails.

let's follow the webpacker's documentation.

at first, install the webapcker gem. we update the Gemfile, bundle.

then, run `bin/rails webpacker:install` command to config webpacker, it will generate many configuration files, we don't need to care about them now.

but you can see, there is a package.json file is created, it means we can install kinds of npm packages here.

webpacker support kinds of front-end framework, likes vue, angular, sitmulus (tracy introduced last week), elm, etc. we choose to use react.

so, run `bin/rails wepbacker:install:react` to install react npm package and generate some sample code.

you can see, in package.json, we have depend the react and react-dom npm packages now.

ok, then let's start to implement the demo pages.

## SSR & CSR demo page

at first, we want to show some movie pages, right? so we create a Movie model.

`bin/rails g model Movie cover_img:string title:string desc:text`

`bin/rails db:migrate`

then, we add 2 movies information to the table, update seed.rb

`bin/rails db:seed`

now, we should see them from rails console.

`bin/rails c`

`> Movie.all`

right?

ok, then, we create a movies controller with 2 actions, ssr and csr.

`bin/rails g controller Movies ssr csr`

at first, we implement the traditional server side rendering page. let it display the first movie.

```
def ssr
  @movie = Movie.find 1
end

# ssr.html.erb
<div class='movie-container'>
  <img class='movie-cover' src=<%= @movie.cover_img %>>
  <div class='movie-info'>
    <h1><%= @movie.title%></h1>
    <p><%= @movie.desc %></p>
  </div>
</div>
```

`bin/rails s`

ok, it works.

let add some css style for it.

then, let's implement csr page.

we can see here generate a `hello_react.jsx` sample file, in this file, it will render a `Hello` component, let's see how to display this component.

in csr.html.erb file, we just need to include this javascript file.

`<%= javascript_pack_tag 'hello_react'>`

let's try it, ok, it works as well, display the `Hello, React`

then, let's replace the Hello component by a MovieItem component.

we create a new component called MovieItem, name the file as movie_item.jsx

the MovieItem component will has a state called movie, at first it should be null, after it is mounted, it will send ajax request to fetch the movie data from server, right?

```
fetch('/movies/1')
  .then(res => res.json())
  .then(movie=>this.setState({movie}))
```

so in the render() function, if movie data is return, it will display the movie info, else, display nothing.

ok, let's also modify the `hello_react.jsx`, let it render MovieItem to replace Hello component.

oh, don't forget to implement the API. in `show` action, we return the json data.

```
def show
  @movie = Movie.find params[:id]
  render json: @movie
end
```

also don't forget add routes for show action.

```
resources :movies
```

let's try the API in browser, it returns the json we want.

let's access the csr page, ok, it works, cool!

## Demo npm package

we have said, the biggest benifit webpacker brings to us is that we can easily to use abundant npm packages, right.

so now, we want to display a star rating component for the movie, there are couples of this kind components other guys have already implemented for us, we just need to choose one, install it and use it.

let's search it by Google, you see, many many.

we choose a simple one, react-stars.

let install it, `yarn add react-stars`, 

it is easy to use, accroding its documentation, we copy and paste its code, import it.

refresh, wow, it works, right, so and quickly.

## Demo blank first screen and workaround

at before we have got some knowledge about blank first screen, right. let's do some more demo.

assume that our database is very slow, it needs 5 seconds to return the data, we use `sleep 5` to simulate it.

```
def ssr
  sleep 5
  @movie = Movie.find 1
end

def show
  sleep 5
  movie = Movie.find 1
  render json: movie
end
```

let's compare their difference.

so you can see, the CSR page will have a long time blank, user will be confused what happend.

a simple workaround way it to add some loading status when the data is empty.

```
return <h1>I am loading... please wait patiently<h1>
```

we can see how it is resolved by SSR later.

## Demo implement react SSR by react-rails

finally, we can talk about how to implement SSR for react to resolve CSR's drawbacks by react-rails.

in fact, it is not complex, just follow react-rails's documentation.

let's install the gem first.

```
gem 'react-rails'
```

then `bundle`

run `bin/rails g react:install` to generate some required files.

it created a `components` folder, and modify the application.js file, in application.js, it is said, it will load the component from components folder, so we should put all our components in componenst folder.

and application.js is should our javascript entry.

so we move the `movie_item` to components folder, and change the csr.html.erb, change `hello_react` to `application`

because we want to do SSR for react, so, the movie data should generate in server, right, let update the `csr` action.

```
def csr
  sleep 5
  @movie = Movie.find 2
end
```

let also update the MovieItem implementation, let it accept a movie props, so we can pass the @movie data to it.

```
MovieItem.propTypes = {
  moive: PropTypes.object
}
```

ok, then, it is the key step. how we render MovieItem in server.

react-rails supply a helper method called `react_component` you can use in the view template, we use it in csr.html.erb:

```
<%= react_compoent('movie_item', {movie: @movie}, {prerender: true}) >
```

this line code will render the MovieItem component in the server side.

let's see what will happened.

see, it will loading a long, but no blank screen any more, right?

and let's see its page source, see, the content is already there, it is SEO friendly now.

## Summary

By webpacker and react-rails gem, we can easily to use react to write our front-end views, use abundant npm packages, do SSR for react.

I think react it is true awesome and cool, flexible, you should have a try. if you guys are interested in it, I can prepare a workshop to lead you to write some react code.

that's all, thank you! 

Any question?
